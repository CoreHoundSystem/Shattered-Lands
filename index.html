<!DOCTYPE html>
<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
	</head>
	<body>
		<script>
			const maps = {
				location: {
					123: {
						mapIMG: 'https://www.oldgames.sk/images/oldgames/rpg/Final.Fantasy.1/Maps/ff1-gba-map_cornelia.png', mapWidth: '704', mapHeight: '544', scale: '16', port: '3123', 
						blocked: [3013,3014,3015,3016,3017,3018,3019]
					}
				}
			}
			move = false;
			//527
			//702
			player = 0;
			$(function() {
				urlToObject($(location).attr('search'),'urlVar');
				console.log(urlVar);//
				loadMap(urlVar.location,urlVar.camp);
			});
			$(function() {
				const overlandMap = $("#map");
					console.log(overlandMap);
			});
			function loadMap(x,y) {
				$('#map').css('width',maps.location[x].mapWidth);
				$('#map').css('height',maps.location[x].mapHeight);
				$('#map').css('background-image','url(' + maps.location[x].mapIMG + ')');
				$('#map').css('background-size',maps.location[x].mapWidth + 'px ' + maps.location[x].mapHeight + 'px');
				createGrid(maps.location[x].scale,y,maps.location[x]);
			}
			function urlToObject(x,y) {
				window[y] = $.parseJSON(x.replace('?','{ "').replace(/=/g,'": "').replace(/&/g,'", "').concat('" }'));
				console.log(window[y]);
			}
			function createGrid(x,y,z) {
				w = $('#map').width();
				h = $('#map').height();
				for(i=1;i<=(h/x);i++) {
					$('#map').append('<div id="row' + i + '" class="mapRow">');
					for(j=1;j<=(w/x);j++) {
						ij = Number((i*100) + j);
						$('#map').find('#row' + i).append('<div id="cell' + ((i*100) + j) + '" class="mapCell" ' + block(z,ij) + '>');
						if(j==(w/x) && i==(h/x)) {
							$('style')[0].append('.mapRow {height: ' + x + 'px;} .mapCell {height: ' + x + 'px; width: ' + x + 'px;}');
						}
					}
				}
				cellID = z.port;
				if($('#cell' + y)) {
					cellID = y;
				}
				//assign character
				l = $('#cell' + cellID).offset().left;
				console.log(l);
				t = $('#cell' + cellID).parent().offset().top;
				console.log(t);
				$('#map').append('<div id="player" style="background-color:red; top: ' + t + 'px; left: ' + l + 'px;" cell="' + y + '">');
				$('style')[0].append('#player {height: ' + z.scale + 'px; width: ' + z.scale + 'px; position: absolute;}');
				player = Number(y);
				console.log(player);
				move = true;
			}
			function block(z,ij) {
				if(z.blocked.indexOf(ij)>-1) {
					return 'block="true"';
				} else {
					return 'block="false"';
				}
			}
			$(document).keydown(function(e) {
				console.log(e);
				console.log(player);
				if(move == true) {
					if (e.keyCode === 38) {
						console.log('You pressed up!');
						console.log($('#cell' + (player - 100)).attr('block'));
						if($('#cell' + (player - 100)).attr('block') == 'false') {
							console.log('Path available.');
							$('#player').css('top',$('#cell' + (player - 100)).parent().offset().top);
							player = player - 100;
						} else {
							console.log('Path blocked!');
						}
					}
					if (e.keyCode === 37) {
						console.log('You pressed left!');
						console.log($('#cell' + (player - 1)).attr('block'));
						if($('#cell' + (player - 1)).attr('block') == 'false') {
							console.log('Path available.');
							$('#player').css('left',$('#cell' + (player - 1)).offset().left);
							player = player - 1;
						} else {
							console.log('Path blocked!');
						}
					}
					if (e.keyCode === 40) {
						console.log('You pressed down!');
						console.log($('#cell' + (player + 100)).attr('block'));
						if($('#cell' + (player + 100)).attr('block') == 'false') {
							console.log('Path available.');
							$('#player').css('top',$('#cell' + (player + 100)).parent().offset().top);
							player = player + 100;
						} else {
							console.log('Path blocked!');
						}
					}
					if (e.keyCode === 39) {
						console.log('You pressed right!');
						console.log($('#cell' + (player + 1)).attr('block'));
						console.log(player + 1);
						if($('#cell' + (player + 1)).attr('block') == 'false') {
							console.log('Path available.');
							$('#player').css('left',$('#cell' + (player + 1)).offset().left);
							player = player + 1;
						} else {
							console.log('Path blocked!');
						}
					}
					console.log($('#cell' + player));
				}
			}); 
		</script>
		<map id="map" name="overlandMap"></map>
		<style>
			#map {
				border: 1px solid black;
				display: block;
				width: 450px;
				height: 450px;
				background-size: cover;
				background-repeat: no-repeat;
			}
			
			.mapRow {
				display: block;
			}
			
			.mapCell {
				display: inline-block;
			}
			
			#cell3422 {
				background: green;
			}
		</style>
	</body>
</html>
